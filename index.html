<!doctype html>
<html>
    <head></head>
    <body>

        <canvas id="canvas" width="320" height="320"></canvas>

        <script src="vendor/jquery.min.js"></script>
        <script src="index.js"></script>
        <p id="status"></p>
        <div>
            <div>
                <label>Population Size</label>
                <input type="text" name="populationSize" value="24" disabled>
            </div>
            <div>
                <label>Max Depth of generated formulae</label>
                <input type="text" name="maxDepth" value="12" disabled>
            </div>

            <div>
                <label>Min Depth of generated formulae</label>
                <input type="text" name="minDepth" value="6" disabled>
            </div>  

            <div>
                <label>Colour Mode</label>
                <div>
                    <label><input type="radio" name="colourMode" disabled value="RGB"> RGB (smaller range, more interpolation)</label>
                    <label><input type="radio" name="colourMode"disabled  value="YUV"> YUV (larger range, less interpolation)</label>
                </div>
            </div>  

            

            <button type="button" data-action="generate-population">Generate new population</button>
            <button type="button" data-action="render">Render</button>

        </div>

        <script>
            $(function() {
                let population = [];
                let grid = [];

                let canvas = document.getElementById('canvas');
                let ctx = canvas.getContext('2d');
                
                $('button[data-action="render"]').click(function(e) {
                    e.preventDefault();
                    $('button').prop('disabled', true);
                   
                    grid = [];
                    render(population, grid, canvas, ctx, () => {
                        $('button').prop('disabled', false);
                    });
                });

                $('button[data-action="generate-population"]').click(function(e) {
                    e.preventDefault();
                    $('button').prop('disabled', true);
                    population = [];
                    population = generatePopulation();
                    console.log(population);
                    $('button').prop('disabled', false);
                    $('button[data-action="render"]').trigger('click');
                   
                });

                $('button[data-action="generate-population"]').trigger('click');

            });
            

            function generatePopulation() {
                $('#status').html('Generating population...');
                let population = [];
                for(let i = 0; i < 24; i++) {
                    population.push(buildRpnExpression(Object.keys(operands), Object.keys(operators.single), Object.keys(operators.double), 12, 0));
                }

                return population;
            }

            function render(population, grid, canvas, ctx, completeFn) {
                
                let width = canvas.width;
                let height = canvas.height;

                let rgbRange = {
                    min: { r: false, g: false, b: false, all: false},
                    max: { r: false, g: false, b: false, all: false}
                };

                $('#status').html('Initiating render...');
               
                let onComplete = () => {
                    $('#status').html('Rendering - second pass - normalized colour values...');

                    let diffs = {
                        r: rgbRange.max.r - rgbRange.min.r,
                        g: rgbRange.max.g - rgbRange.min.g,
                        b: rgbRange.max.b - rgbRange.min.b,
                    }
                    
                    
                    for(let y = 0; y < height; y++) {
                        for(let x = 0; x < width; x++) {
                            //Yield, this allows for progressive rendering of the image
                            setTimeout(function() {
                                window.requestAnimationFrame(function() {
                                    
                                    let cell = grid[y][x];
                                    
                                    cell.r = parseInt((cell.r - rgbRange.min.r) / diffs.r * 255);
                                    cell.g = parseInt((cell.g - rgbRange.min.g)/ diffs.g * 255);
                                    cell.b = parseInt((cell.b - rgbRange.min.g)/ diffs.b * 255);

                                    
                                    //Set the fill style to our rgb values
                                    ctx.fillStyle = `rgb(${cell.r}, ${cell.g}, ${cell.b})`;
                                    
                                    //Draw a dot!
                                    ctx.fillRect(x, y, 1, 1);

                                    if(y === canvas.height - 1 && x === canvas.width - 1) {
                                        completeFn();
                                        $('#status').html('Paint cycles complete');
                                    }
                                });
                            },0);
                        }
                    }
                }


                let indexes = [
                    getRandomInt(0, population.length),
                    getRandomInt(0, population.length),
                    getRandomInt(0, population.length)
                ]; 

                console.log(indexes);
                
                //Yield, to prevent events being blocked
                setTimeout(function() {
                    $('#status').html('Processing - first pass');
                    for(let y = 0; y < height; y++) {
                        for(let x = 0; x < width; x++) {
                            //Yield, this allows for progressive rendering of the image
                            //setTimeout(function() {
                                //window.requestAnimationFrame(function() {
                                
                                    //Select 3 items from the population to solve for red, green and blue
                                    let r = solveRpnExpression(population[indexes[0]].slice(0), x, y);
                                    let g = solveRpnExpression(population[indexes[1]].slice(0), x, y);
                                    let b = solveRpnExpression(population[indexes[2]].slice(0), x, y);

                                    //Setting up variables for second pass render
                                    if(!grid[y]) { 
                                        grid[y] = [];
                                    }

                                    grid[y].push({r: r, g: g, b: b });

                                    if(isFinite(r) && (r < rgbRange.min.r || rgbRange.min.r === false)) {
                                        rgbRange.min.r = r;
                                    }

                                    if(isFinite(g) && (g < rgbRange.min.g || rgbRange.min.g === false)) {
                                        rgbRange.min.g = g;
                                    }

                                    if(isFinite(b) && (b < rgbRange.min.b || rgbRange.min.b === false)) {
                                        rgbRange.min.b = b;
                                    }

                                    if(isFinite(r) && (r > rgbRange.max.r || rgbRange.max.r === false)) {
                                        rgbRange.max.r = r;
                                    }

                                    if(isFinite(g) && (g > rgbRange.max.g || rgbRange.max.g === false)) {
                                        rgbRange.max.g = g;
                                    }

                                    if(isFinite(b) && (b > rgbRange.max.b || rgbRange.max.b === false)) {
                                        rgbRange.max.b = b;
                                    }
                                    // End second pass vars
                                
                                    if(y === canvas.height - 1 && x === canvas.width - 1) {
                                        onComplete();
                                    }
                                //});
                            //}, 0);
                        }
                    }
                }, 0);
            }
            
        </script>
    </body>
</html>


